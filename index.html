using UnityEngine;

public class ReactorScreen : MonoBehaviour
{
    [Header("Slingshot Settings")]
    [SerializeField] private float maxPullDistance = 5f;
    [SerializeField] private float launchForce = 20f;
    [SerializeField] private float maxLaunchForce = 30f;

    [Header("Physics Settings")]
    [SerializeField] private float friction = 0.05f;
    [SerializeField] private float bounciness = 0.8f;
    [SerializeField] private float maxSlideSpeed = 15f;
    [SerializeField] private float gravityScale = 1f;
    [SerializeField] private float angularDrag = 0.1f;
    [SerializeField] private float maxAngularSpeed = 10f;

    private Vector3 startPosition;
    private Vector3 pullDirection;
    private bool isPulling = false;
    private Rigidbody2D rb;
    private PhysicsMaterial2D physicsMaterial;
    private float currentPullDistance = 0f;
    private float currentPullStrength = 0f;
    public bool canPull = true;
    public AudioSource bounceAudioSource; // Assign in Inspector

    private void Start()
    {
        rb = GetComponent<Rigidbody2D>();
        if (rb == null)
        {
            Debug.LogError("Rigidbody2D component not found on the player!");
            return;
        }

        rb.linearDamping = 0f;
        rb.angularDamping = angularDrag;
        rb.gravityScale = gravityScale;
        rb.collisionDetectionMode = CollisionDetectionMode2D.Continuous;
        rb.interpolation = RigidbodyInterpolation2D.Interpolate;
        rb.constraints = RigidbodyConstraints2D.None;

        physicsMaterial = new PhysicsMaterial2D("IceMaterial");
        physicsMaterial.friction = friction;
        physicsMaterial.bounciness = bounciness;
        GetComponent<Collider2D>().sharedMaterial = physicsMaterial;
    }

    private void Update()
    {
        if (!canPull)
            return;

        HandleTouchInput();
        LimitSpeeds();
    }

    private void HandleTouchInput()
    {
        // Handle touch input
        if (Input.touchCount > 0)
        {
            Touch touch = Input.GetTouch(0);
            Vector3 touchPosition = Camera.main.ScreenToWorldPoint(touch.position);
            touchPosition.z = 0;

            if (touch.phase == TouchPhase.Began)
            {
                startPosition = transform.position;
                isPulling = true;
            }
            else if (isPulling && (touch.phase == TouchPhase.Moved || touch.phase == TouchPhase.Stationary))
            {
                pullDirection = startPosition - touchPosition;
                currentPullDistance = Mathf.Clamp(pullDirection.magnitude, 0f, maxPullDistance);
                currentPullStrength = currentPullDistance / maxPullDistance;
                pullDirection = pullDirection.normalized * currentPullDistance;
            }
            else if (touch.phase == TouchPhase.Ended && isPulling)
            {
                Launch();
                isPulling = false;
            }
        }
        // Handle mouse input for WebGL
        else
        {
            Vector3 mousePosition = Camera.main.ScreenToWorldPoint(Input.mousePosition);
            mousePosition.z = 0;

            if (Input.GetMouseButtonDown(0))
            {
                startPosition = transform.position;
                isPulling = true;
            }
            else if (isPulling && Input.GetMouseButton(0))
            {
                pullDirection = startPosition - mousePosition;
                currentPullDistance = Mathf.Clamp(pullDirection.magnitude, 0f, maxPullDistance);
                currentPullStrength = currentPullDistance / maxPullDistance;
                pullDirection = pullDirection.normalized * currentPullDistance;
            }
            else if (Input.GetMouseButtonUp(0) && isPulling)
            {
                Launch();
                isPulling = false;
            }
            else
            {
                currentPullDistance = 0f;
                currentPullStrength = 0f;
            }
        }
    }

    private void LimitSpeeds()
    {
        if (rb != null)
        {
            Vector2 velocity = rb.linearVelocity;
            Vector2 horizontalVelocity = new Vector2(velocity.x, 0);

            if (horizontalVelocity.magnitude > maxSlideSpeed)
            {
                horizontalVelocity = horizontalVelocity.normalized * maxSlideSpeed;
                rb.linearVelocity = new Vector2(horizontalVelocity.x, velocity.y);
            }

            if (Mathf.Abs(rb.angularVelocity) > maxAngularSpeed)
            {
                rb.angularVelocity = Mathf.Sign(rb.angularVelocity) * maxAngularSpeed;
            }
        }
    }

    private void Launch()
    {
        if (rb != null)
        {
            float forceMagnitude = Mathf.Clamp(pullDirection.magnitude * launchForce, 0f, maxLaunchForce);
            rb.AddForce(pullDirection.normalized * forceMagnitude, ForceMode2D.Impulse);

            float randomTorque = Random.Range(-5f, 5f);
            rb.AddTorque(randomTorque, ForceMode2D.Impulse);
        }

        FindObjectOfType<MotionlessPowerup>()?.OnPlayerLaunched();
    }

    private void OnCollisionEnter2D(Collision2D collision)
    {
        if (rb != null && rb.linearVelocity.magnitude > 1f)
        {
            Vector2 randomBounce = new Vector2(
              Random.Range(-0.2f, 0.2f),
              Random.Range(-0.2f, 0.2f)
            );
            rb.linearVelocity += randomBounce;

            float randomTorque = Random.Range(-2f, 2f);
            rb.AddTorque(randomTorque, ForceMode2D.Impulse);

            bounceAudioSource?.Play();
        }
    }

    private void OnGUI()
    {
        if (isPulling)
        {
            float barWidth = 500f;
            float barHeight = 60f;
            float x = 20f;
            float y = 50f;
            GUI.Box(new Rect(x, y, barWidth, barHeight), "");
            GUI.color = Color.green;
            GUI.Box(new Rect(x, y, barWidth * currentPullStrength, barHeight), "");
            GUI.color = Color.white;

            GUIStyle labelStyle = new GUIStyle(GUI.skin.label)
            {
                fontSize = 40,
                fontStyle = FontStyle.Bold,
                normal = { textColor = Color.white },
                alignment = TextAnchor.MiddleLeft
            };
            GUI.Label(new Rect(x, y - 50, barWidth, 50), $"Power: {(int)(currentPullStrength * 100)}%", labelStyle);

            Vector3 worldStart = transform.position;
            Vector3 launchDir = -pullDirection.normalized;
            float lineLength = 2f + currentPullStrength * 2f;
            Vector3 worldEnd = worldStart + launchDir * lineLength;

            Vector3 screenStart = Camera.main.WorldToScreenPoint(worldStart);
            Vector3 screenEnd = Camera.main.WorldToScreenPoint(worldEnd);
            screenStart.y = Screen.height - screenStart.y;
            screenEnd.y = Screen.height - screenEnd.y;

            // Only draw if valid
            if ((screenStart - screenEnd).sqrMagnitude > 0.01f)
            {
                Drawing.DrawLine(screenStart, screenEnd, Color.yellow, 4f, true);
            }

        }
    }

    private void OnDrawGizmos()
    {
        if (isPulling)
        {
            Gizmos.color = Color.red;
            Gizmos.DrawLine(transform.position, transform.position + pullDirection);

            Vector3 arrowStart = transform.position;
            Vector3 launchDir = -pullDirection.normalized;
            float lineLength = 2f + currentPullStrength * 2f;
            Vector3 arrowEnd = arrowStart + launchDir * lineLength;

            Gizmos.color = Color.yellow;
            Gizmos.DrawLine(arrowStart, arrowEnd);
        }
    }
}
